self.addEventListener("fetch",e=>{"navigate"===e.request.mode&&e.respondWith((async()=>{try{const t=await Promise.race([fetch(e.request),new Promise((e,t)=>setTimeout(()=>t(new Error("timeout")),3e3))]),n=new URL(e.request.url);return t.ok&&"/pos"===n.pathname&&((await caches.open("critical-pages-cache")).put(e.request,t.clone()),console.log("Service Worker: Cached POS page")),t}catch(t){console.log("Service Worker: Network failed, trying cache for:",e.request.url);const n=new URL(e.request.url);if("/pos"===n.pathname){const t=await caches.open("critical-pages-cache"),n=await t.match(e.request);if(n)return console.log("Service Worker: Serving POS from critical cache"),n;const o=await t.match("/pos");if(o)return console.log("Service Worker: Serving POS from critical cache (clean URL)"),o}const o=await caches.match(e.request);if(o)return console.log("Service Worker: Serving from cache:",e.request.url),o;const a=n.origin+n.pathname,c=await caches.match(a);if(c)return console.log("Service Worker: Serving from cache (clean URL):",a),c;const r=await caches.keys();for(const e of r){const t=await caches.open(e),o=await t.keys();for(const e of o)if(e.url.includes(n.pathname))return console.log("Service Worker: Found similar cached URL:",e.url),t.match(e)}console.log("Service Worker: No cache found, showing offline page");const i=await caches.match("/offline.html");return i||new Response('\n            <!DOCTYPE html>\n            <html dir="rtl" lang="ar">\n            <head>\n              <meta charset="UTF-8">\n              <meta name="viewport" content="width=device-width, initial-scale=1.0">\n              <title>ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</title>\n              <style>\n                body {\n                  font-family: \'Cairo\', sans-serif;\n                  background: #1F2937;\n                  color: white;\n                  display: flex;\n                  justify-content: center;\n                  align-items: center;\n                  height: 100vh;\n                  margin: 0;\n                  text-align: center;\n                }\n                .container { padding: 20px; }\n                h1 { color: #3B82F6; }\n                button {\n                  background: #3B82F6;\n                  color: white;\n                  border: none;\n                  padding: 12px 24px;\n                  border-radius: 8px;\n                  cursor: pointer;\n                  font-size: 16px;\n                  margin-top: 20px;\n                }\n                button:hover { background: #2563EB; }\n              </style>\n            </head>\n            <body>\n              <div class="container">\n                <h1>ðŸ“¡ Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h1>\n                <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>\n                <button onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>\n              </div>\n            </body>\n            </html>\n          ',{status:503,headers:{"Content-Type":"text/html; charset=utf-8"}})}})())}),self.addEventListener("sync",e=>{console.log("Service Worker: Background sync",e.tag),"sync-offline-sales"===e.tag&&e.waitUntil(async function(){try{(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"SYNC_OFFLINE_SALES",timestamp:Date.now()})}),console.log("Service Worker: Notified clients to sync")}catch(e){console.error("Service Worker: Background sync failed",e)}}())}),self.addEventListener("message",e=>{if(e.data&&"SKIP_WAITING"===e.data.type&&self.skipWaiting(),e.data&&"CLEAR_CACHE"===e.data.type&&caches.keys().then(e=>{e.forEach(e=>{caches.delete(e)})}),e.data&&"CACHE_URLS"===e.data.type){const t=e.data.urls;t&&t.length>0&&caches.open("runtime-cache").then(e=>{e.addAll(t).catch(e=>{console.warn("Failed to cache URLs:",e)})})}if(e.data&&"CACHE_CRITICAL_PAGES"===e.data.type){const t=e.data.pages||[];console.log("Service Worker: Caching critical pages:",t),caches.open("critical-pages-cache").then(async e=>{for(const n of t)try{const t=await fetch(n,{credentials:"include"});t.ok&&(await e.put(n,t),console.log("Service Worker: Cached critical page:",n))}catch(e){console.warn("Service Worker: Failed to cache critical page:",n,e)}})}}),self.addEventListener("push",e=>{console.log("Service Worker: Push received");let t={title:"Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨ÙŠØ¹",body:"Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯"};if(e.data)try{t=e.data.json()}catch(n){t.body=e.data.text()}const n={body:t.body,icon:"/assets/logo/El Farouk Group2.png",badge:"/assets/logo/El Farouk Group2.png",dir:"rtl",lang:"ar",vibrate:[100,50,100],data:t.data||{}};e.waitUntil(self.registration.showNotification(t.title,n))}),self.addEventListener("notificationclick",e=>{console.log("Service Worker: Notification clicked"),e.notification.close(),e.waitUntil(clients.matchAll({type:"window"}).then(e=>{for(const t of e)if(t.url.includes("/pos")&&"focus"in t)return t.focus();if(clients.openWindow)return clients.openWindow("/pos")}))}),console.log("Custom Service Worker Extensions loaded");